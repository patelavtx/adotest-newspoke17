stages:
- stage: validate
  jobs:
  - job: validate
    continueOnError: false
    steps:
    - task: TerraformInstaller@0
      displayName: 'install'
      inputs:
        terraformVersion: '1.1.0'
    - task: TerraformTaskV3@3
      displayName: init
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: 'atulavtx-sst2'
        backendAzureRmResourceGroupName: 'atulrg-optesting'
        backendAzureRmStorageAccountName: 'atulstorspk16'
        backendAzureRmContainerName: 'ctrspk16'
        backendAzureRmKey: 'spk16.tfstate'
    - task: TerraformTaskV3@3
      displayName: 'validate'
      inputs:
        provider: 'azurerm'
        command: 'validate'
- stage: plan
  jobs:
    - deployment: validate_and_plan
      continueOnError: false
      environment: 'spoke16'
      strategy:
       runOnce:
         deploy:
          steps:
            - checkout: self
            - task: TerraformInstaller@0
              displayName: 'install'
              inputs:
                terraformVersion: '1.1.0'
            - task: TerraformTaskV3@3
              displayName: 'init'
              inputs:
                provider: 'azurerm'
                command: 'init'
                backendServiceArm: 'atulavtx-sst2'
                backendAzureRmResourceGroupName: 'atulrg-optesting'
                backendAzureRmStorageAccountName: 'atulstorspk16'
                backendAzureRmContainerName: 'ctrspk16'
                backendAzureRmKey: 'spk16.tfstate'
            - task: TerraformTaskV3@3
              displayName: 'plan'
              inputs:
                provider: 'azurerm'
                command: 'plan'
                #commandOptions: '-input=false -var "ctrl_password=$(TF_VAR_ctrl_password)" -var "controller_ip=$(TF_VAR_controller_ip)"'
                commandOptions: '-var "ctrl_password=$(ctrl_password)" -var "controller_ip=$(controller_ip)"'

                environmentServiceNameAzureRM: 'atulavtx-sst2'
